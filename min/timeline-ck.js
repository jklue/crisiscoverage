function traditionalData(){d3.csv(traditionalSource,function(t){return traditionalDates=t.map(function(t){var e=parseDateQuery(t.date_query_start);return{date:e,count:+t.result_count,type:"traditional"}}),blogData()})}function blogData(){d3.csv(blogSource,function(t){return blogDates=t.map(function(t){var e=parseDateQuery(t.date_query_start);return{date:e,count:+t.result_count,type:"blog"}}),mergeData()})}function mergeData(){var t=[];t.values=blogDates.map(function(t){return t}),t.type="blog",allDates.push(t);var e=[];return e.values=traditionalDates.map(function(t){return t}),e.type="traditional",allDates.push(e),storypoints()}function storypoints(){d3.csv("data/haiyan/storypoints.csv",function(t){return storyPoints=t,storyPoints.forEach(function(t){t.date=parseStorypoint(t.date)}),detailVis()})}function detailVis(){var t,e,a;xDetailScale=d3.time.scale().domain(d3.extent(traditionalDates,function(t){return t.date})).range([0,bbDetail.w]);var n=svg.append("g").attr({"class":"detailFrame",transform:"translate("+bbDetail.x+","+bbDetail.y+")"});a=d3.scale.linear().domain([0,d3.max(allDates,function(t){return d3.max(t.values,function(t){return t.count})})]).range([bbDetail.h,0]),t=d3.svg.axis().scale(xDetailScale).orient("bottom").ticks(4).tickFormat(d3.time.format("%b %d")),e=d3.svg.axis().scale(a).orient("left").ticks(6);var r=d3.svg.area().x(function(t){return xDetailScale(t.date)}).y0(bbDetail.h).y1(function(t){return a(t.count)}),l=d3.svg.line().x(function(t){return xDetailScale(t.date)}).y(function(t){return a(t.count)}).interpolate("linear");n.append("g").attr({"class":"x axis",transform:"translate(0,"+bbDetail.h+")"}).call(t),n.append("g").attr({"class":"y axis"}).call(e).append("text").attr("x",-5).attr("y",-45).attr("dy","30px").style("text-anchor","end").text("Coverage");var i=svg.selectAll(".dataTypes").data(allDates).enter().append("g").attr("class","dataTypes");i.append("path").attr({"class":"traditionalMediaPath",d:function(t){return l(t.values)},transform:"translate(0,"+bbDetail.y+")"}).style({stroke:function(t){return color(t.type)},fill:"none"}),i.append("path").attr({"class":"traditionalMediaArea",d:function(t){return r(t.values)},transform:"translate(0,"+bbDetail.y+")"}).style({fill:function(t){return color(t.type)}}),i.selectAll("circle").data(function(t){return t.values}).enter().append("circle").attr({"class":"dot",cx:function(t){return xDetailScale(t.date)},cy:function(t){return a(t.count)},r:4,transform:"translate(0,"+bbDetail.y+")"}).style({fill:function(t){var e=color(t.type),a=d3.rgb(e).darker();return a}}).on("mouseover",function(t){d3.select(this).transition().duration(25).attr("r",10),s.show(t)}).on("mouseleave",function(t){d3.select(this).transition().duration(25).attr("r",4),s.hide(t)}),d3.select("#crisisTitle").html("<h3>Typhoon Haiyan</h3>"),d3.select("#crisisStory").html('Typhoon Haiyan, known as Typhoon Yolanda in the Philippines, was a powerful tropical cyclone that devastated portions of Southeast Asia, particularly the Philippines, on November 8, 2013. <a href="http://en.wikipedia.org/wiki/Typhoon_Haiyan" class="storySource">&mdash; Wikipedia</a>'),n.selectAll(".line").data(storyPoints).enter().append("line").attr({"class":"storyline",x1:function(t){return xDetailScale(t.date)},x2:function(t){return xDetailScale(t.date)},y1:-bbDetail.y,y2:bbDetail.h}),n.selectAll(".storyTriangle").data(storyPoints).enter().append("path").attr({"class":"storyTriangle",transform:function(t){return"translate("+xDetailScale(t.date)+","+-bbDetail.y+")"},d:d3.svg.symbol().type("triangle-down").size(256)}).on("mouseover",function(t){var e=parseDateTips(t.date);d3.select(".crisisDate").remove(),d3.select("#crisisTitle").append("span").html(e).attr("class","crisisDate"),d3.select("#crisisStory").html(t.title),d3.selectAll(".storyTriangle").transition().style("fill","#919191").attr("d",d3.svg.symbol().type("triangle-down").size(256)),d3.select(this).transition().style("fill","#3D8699").attr("d",d3.svg.symbol().type("triangle-down").size(512))});var s=d3.tip().html(function(t){return 1==t.count?t.count+" '"+t.type+"' article during the week of "+parseDateTips(t.date):t.count+" '"+t.type+"' articles during the week of "+parseDateTips(t.date)}).direction("e").attr("class","d3-tip e");n.call(s)}function sourceChanged(){var t=d3.event.target.value;"bbc"==t?doBBC():"google"==t&&doGoogle()}function doBBC(){function t(){d3.csv("data/archive/2014-04-03-12.09.57_all_no_text-no2011-blog.csv",function(t){t.forEach(function(t,e){t.date_published=parseDate(t.date_published),null!=t.date_published&&duplicateBlogDates.push(t.date_published)}),duplicateBlogDates.sort(function(t,e){return d3.ascending(t,e)});var a;return duplicateBlogDates.forEach(function(t,e){var n=parseDateSimple(t);n!=a?(blogDates.push({date:t,count:1,type:"blog"}),a=n):blogDates[blogDates.length-1].count++}),e()})}function e(){color.domain(["traditional","blog"]);var t=[];t.values=blogDates.map(function(t){return t}),t.type="blog",allDates.push(t);var e=[];return e.values=traditionalDates.map(function(t){return t}),e.type="traditional",allDates.push(e),storypoints()}function a(){var t,e,a;xDetailScale=d3.time.scale().domain(d3.extent(traditionalDates,function(t){return t.date})).range([0,bbDetail.w]),a=d3.scale.linear().domain([0,d3.max(allDates,function(t){return d3.max(t.values,function(t){return t.count})})]).range([bbDetail.h,0]),t=d3.svg.axis().scale(xDetailScale).orient("bottom").ticks(7).tickFormat(d3.time.format("%b")),e=d3.svg.axis().scale(a).orient("left").ticks(6);var n=d3.svg.area().x(function(t){return xDetailScale(t.date)}).y0(bbDetail.h).y1(function(t){return a(t.count)}),r=d3.svg.line().x(function(t){return xDetailScale(t.date)}).y(function(t){return a(t.count)}).interpolate("linear");detailFrame.append("g").attr({"class":"x axis",transform:"translate(0,"+bbDetail.h+")"}).call(t),detailFrame.append("g").attr({"class":"y axis"}).call(e).append("text").attr("x",-5).attr("y",-45).attr("dy","30px").style("text-anchor","end").text("Coverage");var l=BBCsvg.selectAll(".dataTypes").data(allDates).enter().append("g").attr("class","dataTypes");l.append("path").attr({"class":"traditionalMediaPath",d:function(t){return r(t.values)},transform:"translate(0,"+bbDetail.y+")"}).style({stroke:function(t){return color(t.type)},fill:"none"}),l.append("path").attr({"class":"traditionalMediaArea",d:function(t){return n(t.values)},transform:"translate(0,"+bbDetail.y+")"}).style({fill:function(t){return color(t.type)}}),l.selectAll("circle").data(function(t){return t.values}).enter().append("circle").attr({"class":"dot",cx:function(t){return xDetailScale(t.date)},cy:function(t){return a(t.count)},r:4,transform:"translate(0,"+bbDetail.y+")"}).style({fill:function(t){var e=color(t.type),a=d3.rgb(e).darker();return a}}).on("mouseover",function(t){d3.select(this).transition().duration(25).attr("r",10)}).on("mouseleave",function(t){d3.select(this).transition().duration(25).attr("r",4)}),d3.select("#crisisTitle").html("<h3>Typhoon Haiyan</h3>"),d3.select("#crisisStory").html('Typhoon Haiyan, known as Typhoon Yolanda in the Philippines, was a powerful tropical cyclone that devastated portions of Southeast Asia, particularly the Philippines, on November 8, 2013. <a href="http://en.wikipedia.org/wiki/Typhoon_Haiyan" class="storySource">&mdash; Wikipedia</a>'),detailFrame.selectAll(".line").data(storyPoints).enter().append("line").attr({"class":"storyline",x1:function(t){return xDetailScale(t.date)},x2:function(t){return xDetailScale(t.date)},y1:-bbDetail.y,y2:bbDetail.h}),detailFrame.selectAll(".storyTriangle").data(storyPoints).enter().append("path").attr({"class":"storyTriangle",transform:function(t){return"translate("+xDetailScale(t.date)+","+-bbDetail.y+")"},d:d3.svg.symbol().type("triangle-down").size(256)}).on("mouseover",function(t){var e=parseDateTips(t.date);d3.select(".crisisDate").remove(),d3.select("#crisisTitle").append("span").html(e).attr("class","crisisDate"),d3.select("#crisisStory").html(t.title),d3.selectAll(".storyTriangle").transition().style("fill","#919191").attr("d",d3.svg.symbol().type("triangle-down").size(256)),d3.select(this).transition().style("fill","#3D8699").attr("d",d3.svg.symbol().type("triangle-down").size(512))})}d3.selectAll(".axis").remove(),d3.selectAll(".dataTypes").remove(),d3.selectAll(".storyline").remove(),d3.selectAll(".storyTriangle").remove(),traditionalDates.length=0,blogDates.length=0,allDates.length=0,d3.csv("data/archive/2014-04-03-12.09.57_all_no_text-no2011.csv",function(e){e.forEach(function(t,e){t.date_published=parseDate(t.date_published),null!=t.date_published&&duplicateTraditonalDates.push(t.date_published)}),duplicateTraditonalDates.sort(function(t,e){return d3.ascending(t,e)});var a;return duplicateTraditonalDates.forEach(function(t,e){var n=parseDateSimple(t);n!=a?(traditionalDates.push({date:t,count:1,type:"traditional"}),a=n):traditionalDates[traditionalDates.length-1].count++}),t()})}function doGoogle(){d3.selectAll(".axis").remove(),d3.selectAll(".dataTypes").remove(),d3.selectAll(".storyline").remove(),d3.selectAll(".storyTriangle").remove(),traditionalDates.length=0,blogDates.length=0,allDates.length=0,traditionalData()}var allDates,bbDetail,bbOverview,detailFrame,traditionalDates,blogDates,storyPoints,duplicateAllDates,duplicateTraditonalDates,duplicateBlogDates,padding,parseYear,svg,xDetailScale,xOverviewScale,margin={top:50,right:50,bottom:0,left:100},width=960-margin.left-margin.right,height=400-margin.bottom-margin.top;bbOverview={x:0,y:10,w:width,h:50},bbDetail={x:0,y:25,w:width,h:300};var color=d3.scale.ordinal().domain(["traditional","blog"]).range(["#CC1452","#14A6CC"]),padding=30,parseDate=d3.time.format("%Y-%m-%dT%H:%M:%S+00:00").parse,parseDateQuery=d3.time.format("%Y-%m-%d").parse,parseDateSimple=d3.time.format("%b %d %Y"),parseDateTips=d3.time.format("%b %d, %Y"),parseStorypoint=d3.time.format("%Y-%m-%d").parse;allDates=[],traditionalDates=[],duplicateTraditonalDates=[],duplicateBlogDates=[],blogDates=[],svg=d3.select("#timelineVis").append("svg").attr({"class":"timeline",width:width+margin.left+margin.right,height:height+margin.top+margin.bottom}).append("g").attr({transform:"translate("+margin.left+","+margin.top+")"}),svg.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",width).attr("height",height);var traditionalSource="data/haiyan/2014-04-10 12.52.22_haiyan-google-news_query_stats.csv",blogSource="data/haiyan/2014-04-10 12.53.14_haiyan-google-blog_query_stats.csv";traditionalData();var legend=svg.selectAll(".legend").data(["traditional articles","blog articles"]).enter().append("g").attr("class","legend").attr("transform",function(t,e){return"translate(0,"+28*e+")"}).on("mouseout",function(t){d3.selectAll("rect").attr("opacity","1")});legend.append("rect").attr("x",width-18).attr("width",18).attr("height",18).style("fill",color),legend.append("text").attr("x",width-24).attr("y",9).attr("dy",".35em").style("text-anchor","end").text(function(t){return t}),d3.select("#dataSourceSelect").on("change",sourceChanged);