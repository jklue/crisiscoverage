function getData(e,t,a,r){allDates=[],aggregateMediaStats=[],dateList=[],d3.selectAll(".mediaSources").remove(),d3.selectAll(".x.axis").remove(),d3.selectAll(".y.axis").remove(),d3.selectAll(".x.axis2").remove(),d3.selectAll(".y.axis2").remove(),d3.selectAll(".storyline").remove(),d3.selectAll(".storyTriangle").remove(),summary=t,storyPoints=a,storyPoints.forEach(function(e){e.date=parseStorypoint(e.date)});var n=r.map(function(e){return e.site_name});sources=[],n.forEach(function(e,t){0===t?sources.push(e):-1==sources.indexOf(e)&&sources.push(e)}),r.forEach(function(e){e.date_query_end=parseDateQuery(e.date_query_end),dateList.push(e.date_query_end)});var i=[];sources.forEach(function(e,t){var a=[];a.name=e;var n=e.replace(/[\. ]+/g,"");a.id=n,a.vis=1,a.values=[],r.forEach(function(t){e==t.site_name&&a.values.push({date:t.date_query_end,count:+t.raw_result_count,name:e,type:t.site_type,id:n,vis:1})}),allDates.push(a)}),color=d3.scale.category20();var s=[];return allDates[0].values.forEach(function(e){s.push(e.date)}),mediaTypes.forEach(function(e){var t=[];t.name=e,t.values=[],s.forEach(function(a){var n=0;r.forEach(function(t){e==t.site_type&&a.getTime()==t.date_query_end.getTime()&&(n+=+t.raw_result_count)}),t.values.push({date:a,count:n,name:e})}),aggregateMediaStats.push(t)}),typeVis()}function resetSummaryTimeline(){d3.selectAll(".storyTriangle").transition().style("fill","#919191").attr("d",d3.svg.symbol().type("triangle-down").size(256)),"content-tab active"===document.getElementById("tab_1_compared").className?(d3.select("#crisisTitle").html("<h3>Relative Interest In Crises</h3>"),d3.select("#crisisStory").html("Percentage of change in crisis coverage can be compared from month to month to determine increased, same, or decreased media attention aggregated across all Google results."),$("#crisis_selector").hide()):($("#crisis_selector").show(),d3.select("#crisisTitle").data(summary).html(function(e){return"<h3>"+e.title+"</h3>"}),d3.select("#crisisStory").data(summary).html(function(e){return"<p>"+e.content+"</p>"}))}function typeVis(){var e=75;xScale=d3.time.scale().domain(d3.extent(dateList,function(e){return e})).range([e,typeDetail.w]),yScale=d3.scale.linear().domain([0,d3.max(aggregateMediaStats,function(e){return d3.max(e.values,function(e){return e.count})})]).range([typeDetail.h,0]);var t=typeSVG.append("g").attr({"class":"typeFrame",transform:"translate("+typeDetail.x+","+typeDetail.y+")"});xAxis=d3.svg.axis().scale(xScale).orient("bottom").ticks(4).tickFormat(d3.time.format("%b")),yAxis=d3.svg.axis().scale(yScale).orient("left").ticks(6);var a=d3.svg.line().x(function(e){return xScale(e.date)}).y(function(e){return yScale(e.count)}).interpolate("linear");t.append("g").attr({"class":"x axis",transform:"translate(0,"+typeDetail.h+")"}).call(xAxis),d3.select(".x.axis").append("line").attr({x1:100,x2:0,y1:3,y2:3}).style({stroke:"#ccc","stroke-width":6}),t.append("g").attr("class","y axis").call(yAxis).append("text").attr("x",-5).attr("y",-45).attr("dy","30px").style("text-anchor","end").text("# articles");var r=aggregateMediaStats,n=typeSVG.append("g").attr("clip-path","url(#chart-area)"),i=n.selectAll(".mediaSources").data(r).enter().append("g").attr("class","mediaSources");i.append("path").attr({"class":function(e){return e.id+" path"},id:function(e){return e.name},d:function(e){return a(e.values)},transform:"translate(0,"+typeDetail.y+")"}).style({stroke:function(e){return color(e.name)},fill:"none"}),i.selectAll("circle").data(function(e){return e.values}).enter().append("circle").attr({"class":function(e){return e.id+" dot"},cx:function(e){return xScale(e.date)},cy:function(e){return yScale(e.count)},r:4,transform:"translate(0,"+typeDetail.y+")"}).style({fill:function(e){var t=color(e.name),a=d3.rgb(t).darker();return a}}).on("mouseover",function(e){d3.select(this).transition().duration(25).attr("r",10),s.show(e)}).on("mouseleave",function(e){d3.select(this).transition().duration(25).attr("r",4),s.hide(e)}),i.append("text").attr({"class":function(e){return e.id+"legend"},x:typeWidth+120,y:function(e,t){return 16*t+typeMargin.top},dy:"0.35em",fill:function(e){return color(e.name)}}).style("text-anchor","end").text(function(e){return e.name}),t.selectAll(".line").data(storyPoints).enter().append("line").attr({"class":"storyline",x1:function(e){return xScale(e.date)},x2:function(e){return xScale(e.date)},y1:-typeDetail.y,y2:typeDetail.h}),t.selectAll(".storyTriangle").data(storyPoints).enter().append("path").attr({"class":"storyTriangle",transform:function(e){return"translate("+xScale(e.date)+","+-typeDetail.y+")"},d:d3.svg.symbol().type("triangle-down").size(256)}).on("mouseover",function(e){var t=parseDateTips(e.date);d3.select(".crisisDate").remove(),d3.select("#crisisTitle").append("span").html(t).attr("class","crisisDate"),d3.select("#crisisStory").html(e.title),d3.selectAll(".storyTriangle").transition().style("fill","#919191").attr("d",d3.svg.symbol().type("triangle-down").size(256)),d3.select(this).transition().style("fill","#3D8699").attr("d",d3.svg.symbol().type("triangle-down").size(512))});var s=d3.tip().html(function(e){return e.count+" <span class='sourceName'>"+e.name+"</span> articles on during<br>the 30 days prior to "+parseDateTips(e.date)}).direction("e").attr("class","d3-tip e");t.call(s),sourceVis()}function sourceVis(){var e=75;xScale2=d3.time.scale().domain(d3.extent(dateList,function(e){return e})).range([e,sourceDetail.w]),yScale2=d3.scale.linear().domain([0,d3.max(allDates,function(e){return d3.max(e.values,function(e){return e.count})})]).range([sourceDetail.h,0]);var t=sourceSVG.append("g").attr({"class":"sourceFrame",transform:"translate("+sourceDetail.x+","+sourceDetail.y+")"}),a=d3.svg.axis().scale(xScale2).orient("bottom").ticks(4).tickFormat(d3.time.format("%b"));yAxis2=d3.svg.axis().scale(yScale2).orient("left").ticks(6),line=d3.svg.line().x(function(e){return xScale2(e.date)}).y(function(e){return yScale2(e.count)}).interpolate("linear"),t.append("g").attr({"class":"x axis2",transform:"translate(0,"+sourceDetail.h+")"}).call(a),d3.select(".x.axis2").append("line").attr({x1:100,x2:0,y1:3,y2:3}).style({stroke:"#ccc","stroke-width":6}),t.append("g").attr("class","y axis2").call(yAxis2).append("text").attr("x",-5).attr("y",-45).attr("dy","30px").style("text-anchor","end").text("# articles"),visibleDates=allDates.map(function(e){return{id:e.id,name:e.name,values:e.values.map(function(e){return{count:e.count,date:e.date,id:e.id,name:e.name,type:e.type,vis:e.vis}}),vis:e.vis}});var r=sourceSVG.append("g").attr("clip-path","url(#chart-area)");mediaSources=r.selectAll(".mediaSources").data(visibleDates).enter().append("g").attr("class","mediaSources"),mediaSources.append("path").attr({"class":function(e){return e.id+" path"},d:function(e){return line(e.values)},transform:"translate(0,"+sourceDetail.y+")"}).style({stroke:function(e){return color(e.name)},fill:"none"}),mediaSources.selectAll("circle").data(function(e){return e.values}).enter().append("circle").attr({"class":function(e){return e.id+" dot"},cx:function(e){return xScale2(e.date)},cy:function(e){return yScale2(e.count)},r:4,transform:"translate(0,"+sourceDetail.y+")"}).style({fill:function(e){var t=color(e.name),a=d3.rgb(t).darker();return a}}).on("mouseover",function(e){d3.select(this).transition().duration(25).attr("r",10),n.show(e)}).on("mouseleave",function(e){d3.select(this).transition().duration(25).attr("r",4),n.hide(e)}),mediaSources.append("text").attr({"class":function(e){return e.id+"legend"},x:sourceWidth+160,y:function(e,t){return 16*t+8},dy:"0.35em",cursor:"pointer",fill:function(e){return color(e.name)}}).style("text-anchor","end").text(function(e){return e.name}).on("click",function(e){"#ccc"!=d3.select(this).attr("fill")?(d3.select(this).attr("fill","#ccc"),visibleDates.forEach(function(t,a){t.id==e.id&&(t.vis=0,t.values.forEach(function(e){e.count=null,e.vis=0}))})):(d3.select(this).attr("fill",function(e){return color(e.name)}),visibleDates.forEach(function(t,a){t.id==e.id&&allDates.forEach(function(e){e.id==t.id&&(t.vis=1,t.values=e.values.map(function(e){return{count:e.count,date:e.date,id:e.id,name:e.name,type:e.type}}))})})),yScale2.domain([0,d3.max(visibleDates,function(e){return d3.max(e.values,function(e){return e.count})})]),d3.select(".y.axis2").transition().duration(1500).ease("sin-in-out").call(yAxis2),mediaSources.selectAll("path").transition().duration(500).attr("d",function(e){return line(e.values)}),mediaSources.selectAll("circle").data(function(e){return e.values}).transition().duration(500).attr({cx:function(e){return xScale2(e.date)},cy:function(e){return yScale2(e.count)}}).style({fill:function(e){if(0==e.vis)return"white";var t=color(e.name),a=d3.rgb(t).darker();return a}})}),mediaSources.append("foreignObject").attr({width:20,height:20,x:sourceWidth+170,y:function(e,t){return 16*t}}).append("xhtml:input").attr({id:function(e){return e.id},type:"checkbox",value:function(e){return e},checked:!0}).on("click",function(e){var t=d3.select(this);labelClick(t)}),t.selectAll(".line").data(storyPoints).enter().append("line").attr({"class":"storyline",x1:function(e){return xScale2(e.date)},x2:function(e){return xScale2(e.date)},y1:-sourceDetail.y,y2:sourceDetail.h}),t.selectAll(".storyTriangle").data(storyPoints).enter().append("path").attr({"class":"storyTriangle",transform:function(e){return"translate("+xScale2(e.date)+","+-sourceDetail.y+")"},d:d3.svg.symbol().type("triangle-down").size(256)}).on("mouseover",function(e){var t=parseDateStory(e.date);d3.select(".crisisDate").remove(),d3.select("#crisisTitle").append("span").html(t).attr("class","crisisDate"),d3.select("#crisisStory").html(e.title),d3.selectAll(".storyTriangle").transition().style("fill","#919191").attr("d",d3.svg.symbol().type("triangle-down").size(256)),d3.select(this).transition().style("fill","#3D8699").attr("d",d3.svg.symbol().type("triangle-down").size(512))});var n=d3.tip().html(function(e){return e.count+" articles on <span class='sourceName'>"+e.name+"</span> during<br>the 30 days prior to "+parseDateTips(e.date)}).direction("e").attr("class","d3-tip e");t.call(n);var i=d3.select("#Google");i[0][0].checked=!1,labelClick(i),resetSummaryTimeline()}function labelClick(e){var t=e[0][0].checked,a=e.data()[0];visibleDates.forEach(0==t?function(e,t){e.id==a.id&&(e.vis=0,e.values.forEach(function(e){e.count=null}))}:function(e,t){e.id==a.id&&allDates.forEach(function(t){t.id==e.id&&(e.vis=1,e.values=t.values.map(function(e){return{count:e.count,date:e.date,id:e.id,name:e.name,type:e.type}}))})}),yScale2.domain([0,d3.max(visibleDates,function(e){return d3.max(e.values,function(e){return e.count})})]),d3.select(".y.axis2").transition().duration(1500).ease("sin-in-out").call(yAxis2),mediaSources.selectAll("path").transition().duration(500).attr("d",function(e){return line(e.values)}),mediaSources.selectAll("circle").data(function(e){return e.values}).transition().duration(500).attr({cx:function(e){return xScale2(e.date)},cy:function(e){return yScale2(e.count)}}).style({fill:function(e){if(0===e.vis)return"white";var t=color(e.name),a=d3.rgb(t).darker();return a}})}function loadedComparedTimelineCallback(e,t){console.log("---- START ::: CRISES COMPARED ---");var a=t;console.log("mediaData length: "+a.length),console.log(a);var r=1,n=7,i={top:50,right:140,bottom:0,left:70},s=990-i.left-i.right,c=450-i.bottom-i.top,o={x:0,y:25,w:s,h:350},l=d3.scale.category20(),d=d3.select("#timelineComparedVis").append("svg").attr({id:"timeline-compared","class":"timeline",width:s+i.left+i.right,height:c+i.top+i.bottom}).append("g").attr({transform:"translate("+i.left+","+i.top+")"}),u=d3.scale.linear().domain([r,n]).range([0,o.w]),p=d3.scale.linear().domain([-100,100]).range([o.h,0]),m=d3.svg.line().x(function(e){return u(e.coverage_month)}).y(function(e){return p(e.percent_change)}).interpolate("linear"),y=d3.svg.axis().scale(u).orient("top").ticks(n).tickSize(6,0,0).tickFormat(function(e){return 1===e||7===e?"":e}),f=d3.svg.axis().scale(p).orient("left").ticks(6);d3.select("#timeline-compared").select("g").append("g").attr("class","axis").attr("transform","translate(0,"+o.h/2+")").call(y).append("text").attr("x",o.w+2).attr("y",-13).attr("dy",".71em").style("text-anchor","end").text("crisis month"),d3.select("#timeline-compared").select("g").append("g").attr("class","axis").call(f).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text("% change"),d.selectAll(".axis line, .axis path").style({stroke:"#CCC",fill:"#CCC","stroke-width":"1px"}),d.selectAll(".axis text").style({fill:"#CCC"});var g=d.selectAll(".series").data(a).enter().append("g").attr("class","series");g.append("path").attr("class",function(e){return e.name+" path"}).attr("d",function(e){return m(e.values)}).style("stroke",function(e){return l(e.name)}).style("stroke-width","4px").style("fill","none"),g.selectAll("circle").data(function(e){return e.values}).enter().append("circle").attr({"class":function(e){return e.name+" dot"},cx:function(e){return u(e.coverage_month)},cy:function(e){return p(e.percent_change)},r:4}).style({fill:function(e){var t=l(e.name),a=d3.rgb(t).darker();return a}}).on("mouseover",function(e){d3.select(this).transition().duration(25).attr("r",10),h.show(e)}).on("mouseleave",function(e){d3.select(this).transition().duration(25).attr("r",4),h.hide(e)}),g.append("text").attr({"class":function(e){return e.name+"legend"},x:s+120,y:function(e,t){return 16*t+i.top},dy:"0.35em",fill:function(e){return l(e.name)}}).style("text-anchor","end").text(function(e){return e.name});var h=d3.tip().html(function(e){var t=e.coverage_month,a=l(e.name),r=!1;if(t>1){var n="stayed the same",i=e.percent_change;return e.percent_change>0?n="increased by ":e.percent_change<0?(n="decreased by ",i=Math.abs(e.percent_change)):r=!0,"<span class='sourceName'  style='color:"+a+";'>"+e.name+": </span>from month "+(t-1)+" to "+t+"<br>coverage "+n+(r?"":i+"%")+"."}return"<span class='sourceName'  style='color:"+a+";'>"+e.name+": </span>at first month of crisis coverage."}).direction("e").attr("class","d3-tip e");g.call(h),console.log("---- END ::: CRISES COMPARED ---")}var allDates,aggregateMediaStats,crisis,dateList,color,mediaSources,storyPoints,line,mediaTypes,sources,summary,visibleDates,xAxis,xScale,yAxis,yScale,xScale2,yAxis2,yScale2,parseDateQuery=d3.time.format("%Y-%m-%d").parse,parseDateTips=d3.time.format("%b %d, %Y"),parseStorypoint=d3.time.format("%Y-%m-%d").parse,parseDateStory=d3.time.format("%b %Y");mediaTypes=["Traditional","Independent","Blogs-Social"];var typeMargin={top:50,right:140,bottom:0,left:70},typeWidth=990-typeMargin.left-typeMargin.right,typeHeight=450-typeMargin.bottom-typeMargin.top,typeDetail={x:0,y:25,w:typeWidth,h:350},typePadding=30,sourceMargin={top:50,right:200,bottom:0,left:70},sourceWidth=990-sourceMargin.left-sourceMargin.right,sourceHeight=450-sourceMargin.bottom-sourceMargin.top,sourceDetail={x:0,y:25,w:sourceWidth,h:350},sourcePadding=30,typeSVG=d3.select("#timelineTypeVis").append("svg").attr({"class":"timeline",width:typeWidth+typeMargin.left+typeMargin.right,height:typeHeight+typeMargin.top+typeMargin.bottom}).append("g").attr({transform:"translate("+typeMargin.left+","+typeMargin.top+")"});typeSVG.append("clipPath").attr("id","type-chart-area").append("rect").attr({x:-typePadding,y:-typePadding-5,width:typeDetail.w+12*typePadding,height:typeDetail.h+1.97*typePadding});var sourceSVG=d3.select("#timelineSourceVis").append("svg").attr({"class":"timeline",width:sourceWidth+sourceMargin.left+sourceMargin.right,height:sourceHeight+sourceMargin.top+sourceMargin.bottom}).append("g").attr({transform:"translate("+sourceMargin.left+","+sourceMargin.top+")"});sourceSVG.append("clipPath").attr("id","chart-area").append("rect").attr({x:-sourcePadding,y:-sourcePadding-5,width:sourceDetail.w+12*sourcePadding,height:sourceDetail.h+1.97*sourcePadding}),$(document).ready(function(){queue().defer(d3.json,"/productiondata/compared_timeline.json").await(loadedComparedTimelineCallback),document.getElementById("tab_1_compared").className="content-tab active",addClassNameListener("tab_1_compared",function(){var e=document.getElementById("tab_1_compared").className;"content-tab active"===e&&(console.log("... tab change to tab_1_compared."),resetSummaryTimeline())}),addClassNameListener("tab_2_type",function(){var e=document.getElementById("tab_2_type").className;"content-tab active"===e&&(console.log("... tab change to tab_2_type."),resetSummaryTimeline())}),addClassNameListener("tab_3_source",function(){var e=document.getElementById("tab_3_source").className;"content-tab active"===e&&(console.log("... tab change to tab_3_source."),resetSummaryTimeline())})}),addClassNameListener("crisis_select",function(){crisis=window.crisis_select.value,console.log("### QUEUE NEW CRISIS ("+crisis+") AFTER CLASS CHANGE ###"),queue().defer(d3.csv,"/productiondata/"+crisis+"/summary.csv").defer(d3.csv,"/productiondata/"+crisis+"/storypoints.csv").defer(d3.csv,"/productiondata/"+crisis+"/google-media_stats.csv").await(getData)});