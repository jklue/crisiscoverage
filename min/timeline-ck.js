function getData(){d3.csv(mediaStats,function(t){originalData=t;var e=t.map(function(t){return t.site_name});sources=[],e.forEach(function(t,e){0==e?sources.push(t):-1==sources.indexOf(t)&&sources.push(t)}),sources.shift(),t.forEach(function(t){t.date_query_end=parseDateQuery(t.date_query_end),dateList.push(t.date_query_end)});var a=[];return sources.forEach(function(e,a){var n=[];n.name=e;var r=e.replace(/[\. ]+/g,"");n.id=r,n.vis=1,n.values=[],t.forEach(function(t){e==t.site_name&&n.values.push({date:t.date_query_end,count:+t.raw_result_count,name:e,type:t.site_type,id:r,vis:1})}),allDates.push(n)}),color=d3.scale.category20(),aggregateData()})}function aggregateData(){var t=[];return allDates[0].values.forEach(function(e){t.push(e.date)}),mediaTypes.forEach(function(e){var a=[];a.name=e,a.values=[],t.forEach(function(t){var n=0;originalData.forEach(function(a){e==a.site_type&&t.getTime()==a.date_query_end.getTime()&&(n+=+a.raw_result_count)}),a.values.push({date:t,count:n,name:e})}),aggregateMediaStats.push(a)}),storypoints()}function storypoints(){d3.csv("data/haiyan/storypoints.csv",function(t){return storyPoints=t,storyPoints.forEach(function(t){t.date=parseStorypoint(t.date)}),typeVis()})}function typeVis(){var t={top:50,right:140,bottom:0,left:70},e=990-t.left-t.right,a=450-t.bottom-t.top,n={x:0,y:10,w:e,h:50},r={x:0,y:25,w:e,h:350},i=30;svg=d3.select("#timelineTypeVis").append("svg").attr({"class":"timeline",width:e+t.left+t.right,height:a+t.top+t.bottom}).append("g").attr({transform:"translate("+t.left+","+t.top+")"}),svg.append("clipPath").attr("id","type-chart-area").append("rect").attr({x:-i,y:-i-5,width:r.w+12*i,height:r.h+1.97*i}),xScale=d3.time.scale().domain(d3.extent(dateList,function(t){return t})).range([0,r.w]);var s=svg.append("g").attr({"class":"typeFrame",transform:"translate("+r.x+","+r.y+")"});yScale=d3.scale.linear().domain([0,d3.max(aggregateMediaStats,function(t){return d3.max(t.values,function(t){return t.count})})]).range([r.h,0]),xAxis=d3.svg.axis().scale(xScale).orient("bottom").ticks(4).tickFormat(d3.time.format("%b")),yAxis=d3.svg.axis().scale(yScale).orient("left").ticks(6);var o=d3.svg.line().x(function(t){return xScale(t.date)}).y(function(t){return yScale(t.count)}).interpolate("linear");s.append("g").attr({"class":"x axis",transform:"translate(0,"+r.h+")"}).call(xAxis),s.append("g").attr("class","y axis").call(yAxis).append("text").attr("x",-5).attr("y",-45).attr("dy","30px").style("text-anchor","end").text("# articles");var l=aggregateMediaStats;console.log("aggregateMediaStats",aggregateMediaStats),console.log("allDates",allDates);var c=svg.append("g").attr("clip-path","url(#chart-area)"),d=c.selectAll(".mediaSources").data(l).enter().append("g").attr("class","mediaSources");d.append("path").attr({"class":function(t){return t.id+" path"},id:function(t){return t.name},d:function(t){return o(t.values)},transform:"translate(0,"+r.y+")"}).style({stroke:function(t){return color(t.name)},fill:"none"}),d.selectAll("circle").data(function(t){return t.values}).enter().append("circle").attr({"class":function(t){return t.id+" dot"},cx:function(t){return xScale(t.date)},cy:function(t){return yScale(t.count)},r:4,transform:"translate(0,"+r.y+")"}).style({fill:function(t){var e=color(t.name),a=d3.rgb(e).darker();return a}}).on("mouseover",function(t){d3.select(this).transition().duration(25).attr("r",10),u.show(t)}).on("mouseleave",function(t){d3.select(this).transition().duration(25).attr("r",4),u.hide(t)}),d.append("text").attr({"class":function(t){return t.id+"legend"},x:e+120,y:function(e,a){return 16*a+t.top},dy:"0.35em",fill:function(t){return color(t.name)}}).style("text-anchor","end").text(function(t){return t.name}),d3.select("#crisisTitle").html("<h3>Typhoon Haiyan</h3>"),d3.select("#crisisStory").html('Typhoon Haiyan, known as Typhoon Yolanda in the Philippines, was a powerful tropical cyclone that devastated portions of Southeast Asia, particularly the Philippines, on November 8, 2013. <a href="http://en.wikipedia.org/wiki/Typhoon_Haiyan" class="storySource">&mdash; Wikipedia</a>'),s.selectAll(".line").data(storyPoints).enter().append("line").attr({"class":"storyline",x1:function(t){return xScale(t.date)},x2:function(t){return xScale(t.date)},y1:-r.y,y2:r.h}),s.selectAll(".storyTriangle").data(storyPoints).enter().append("path").attr({"class":"storyTriangle",transform:function(t){return"translate("+xScale(t.date)+","+-r.y+")"},d:d3.svg.symbol().type("triangle-down").size(256)}).on("mouseover",function(t){var e=parseDateTips(t.date);d3.select(".crisisDate").remove(),d3.select("#crisisTitle").append("span").html(e).attr("class","crisisDate"),d3.select("#crisisStory").html(t.title),d3.selectAll(".storyTriangle").transition().style("fill","#919191").attr("d",d3.svg.symbol().type("triangle-down").size(256)),d3.select(this).transition().style("fill","#3D8699").attr("d",d3.svg.symbol().type("triangle-down").size(512))});var u=d3.tip().html(function(t){return t.count+" <span class='sourceName'>"+t.name+"</span> articles on during<br>the 30 days prior to "+parseDateTips(t.date)}).direction("e").attr("class","d3-tip e");s.call(u),sourceVis()}function sourceVis(){var t={top:50,right:200,bottom:0,left:70},e=990-t.left-t.right,a=450-t.bottom-t.top,n={x:0,y:10,w:e,h:50},r={x:0,y:25,w:e,h:350},i=30;svg=d3.select("#timelineSourceVis").append("svg").attr({"class":"timeline",width:e+t.left+t.right,height:a+t.top+t.bottom}).append("g").attr({transform:"translate("+t.left+","+t.top+")"}),svg.append("clipPath").attr("id","chart-area").append("rect").attr({x:-i,y:-i-5,width:r.w+12*i,height:r.h+1.97*i});var s=allDates;xScale=d3.time.scale().domain(d3.extent(dateList,function(t){return t})).range([0,r.w]);var o=svg.append("g").attr({"class":"detailFrame",transform:"translate("+r.x+","+r.y+")"});yScale=d3.scale.linear().domain([0,d3.max(allDates,function(t){return d3.max(t.values,function(t){return t.count})})]).range([r.h,0]),xAxis=d3.svg.axis().scale(xScale).orient("bottom").ticks(4).tickFormat(d3.time.format("%b")),yAxis=d3.svg.axis().scale(yScale).orient("left").ticks(6);var l=d3.svg.line().x(function(t){return xScale(t.date)}).y(function(t){return yScale(t.count)}).interpolate("linear");o.append("g").attr({"class":"x axis",transform:"translate(0,"+r.h+")"}).call(xAxis),o.append("g").attr("class","y axis").call(yAxis).append("text").attr("x",-5).attr("y",-45).attr("dy","30px").style("text-anchor","end").text("# articles");var c=allDates.map(function(t){return{id:t.id,name:t.name,values:t.values.map(function(t){return{count:t.count,date:t.date,id:t.id,name:t.name,type:t.type,vis:t.vis}}),vis:t.vis}}),d=svg.append("g").attr("clip-path","url(#chart-area)"),u=d.selectAll(".mediaSources").data(c).enter().append("g").attr("class","mediaSources");u.append("path").attr({"class":function(t){return t.id+" path"},d:function(t){return l(t.values)},transform:"translate(0,"+r.y+")"}).style({stroke:function(t){return color(t.name)},fill:"none"}),u.selectAll("circle").data(function(t){return t.values}).enter().append("circle").attr({"class":function(t){return t.id+" dot"},cx:function(t){return xScale(t.date)},cy:function(t){return yScale(t.count)},r:4,transform:"translate(0,"+r.y+")"}).style({fill:function(t){var e=color(t.name),a=d3.rgb(e).darker();return a}}).on("mouseover",function(t){d3.select(this).transition().duration(25).attr("r",10),p.show(t)}).on("mouseleave",function(t){d3.select(this).transition().duration(25).attr("r",4),p.hide(t)}),u.append("text").attr({"class":function(t){return t.id+"legend"},x:e+180,y:function(e,a){return 16*a+t.top/2},dy:"0.35em",cursor:"pointer",fill:function(t){return color(t.name)}}).style("text-anchor","end").text(function(t){return t.name}).on("click",function(t){"#ccc"!=d3.select(this).attr("fill")?(d3.select(this).attr("fill","#ccc"),c.forEach(function(e,a){e.id==t.id&&(e.vis=0,e.values.forEach(function(t){t.count=null,t.vis=0}))})):(d3.select(this).attr("fill",function(t){return color(t.name)}),c.forEach(function(e,a){e.id==t.id&&allDates.forEach(function(t){t.id==e.id&&(e.vis=1,e.values=t.values.map(function(t){return{count:t.count,date:t.date,id:t.id,name:t.name,type:t.type}}))})})),yScale.domain([0,d3.max(c,function(t){return d3.max(t.values,function(t){return t.count})})]),d3.select(".y.axis").transition().duration(1500).ease("sin-in-out").call(yAxis),console.log(c),u.selectAll("path").transition().duration(500).attr("d",function(t){return l(t.values)}),u.selectAll("circle").data(function(t){return console.log("d.vis",t.vis),t.values}).transition().duration(500).attr({cx:function(t){return xScale(t.date)},cy:function(t){return yScale(t.count)}}).style({fill:function(e){if(console.log(t),0==e.vis)return"white";var a=color(e.name),n=d3.rgb(a).darker();return n}})}),d3.select("#crisisTitle").html("<h3>Typhoon Haiyan</h3>"),d3.select("#crisisStory").html('Typhoon Haiyan, known as Typhoon Yolanda in the Philippines, was a powerful tropical cyclone that devastated portions of Southeast Asia, particularly the Philippines, on November 8, 2013. <a href="http://en.wikipedia.org/wiki/Typhoon_Haiyan" class="storySource">&mdash; Wikipedia</a>'),o.selectAll(".line").data(storyPoints).enter().append("line").attr({"class":"storyline",x1:function(t){return xScale(t.date)},x2:function(t){return xScale(t.date)},y1:-r.y,y2:r.h}),o.selectAll(".storyTriangle").data(storyPoints).enter().append("path").attr({"class":"storyTriangle",transform:function(t){return"translate("+xScale(t.date)+","+-r.y+")"},d:d3.svg.symbol().type("triangle-down").size(256)}).on("mouseover",function(t){var e=parseDateTips(t.date);d3.select(".crisisDate").remove(),d3.select("#crisisTitle").append("span").html(e).attr("class","crisisDate"),d3.select("#crisisStory").html(t.title),d3.selectAll(".storyTriangle").transition().style("fill","#919191").attr("d",d3.svg.symbol().type("triangle-down").size(256)),d3.select(this).transition().style("fill","#3D8699").attr("d",d3.svg.symbol().type("triangle-down").size(512))});var p=d3.tip().html(function(t){return t.count+" articles on <span class='sourceName'>"+t.name+"</span> during<br>the 30 days prior to "+parseDateTips(t.date)}).direction("e").attr("class","d3-tip e");o.call(p)}var allDates,aggregateMediaStats,detailFrame,dateList,color,storyPoints,line,mediaTypes,originalData,padding,sources,svg,xAxis,xScale,yAxis,yScale,parseDate=d3.time.format("%Y-%m-%dT%H:%M:%S+00:00").parse,parseDateQuery=d3.time.format("%Y-%m-%d").parse,parseDateSimple=d3.time.format("%b %d %Y"),parseDateTips=d3.time.format("%b %d, %Y"),parseStorypoint=d3.time.format("%Y-%m-%d").parse;allDates=[],aggregateMediaStats=[],mediaTypes=["Traditional","Independent","Blogs-Social"],dateList=[];var mediaStats="productiondata/haiyan/google-media_stats.csv";getData();