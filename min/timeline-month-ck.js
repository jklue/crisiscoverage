function getData(){d3.csv(mediaStats,function(t){var e=t.map(function(t){var e=t.query_distinct.substring(0,t.query_distinct.length-3);return e});sources=[],e.forEach(function(t,e){0==e?sources.push(t):-1==sources.indexOf(t)&&sources.push(t)}),console.log("sources: ",sources),t.forEach(function(t){t.date_query_end=parseDateQuery(t.date_query_end),dateList.push(t.date_query_end)});var a=[];return sources.forEach(function(e,a){var r=[];r.name=e,r.values=[],t.forEach(function(t){var a=t.query_distinct.substring(0,t.query_distinct.length-3);e==a&&r.values.push({date:t.date_query_end,count:+t.raw_result_count,name:e})}),allDates.push(r)}),color=d3.scale.category20(),storypoints()})}function storypoints(){d3.csv("data/haiyan/storypoints.csv",function(t){return storyPoints=t,storyPoints.forEach(function(t){t.date=parseStorypoint(t.date)}),detailVis()})}function detailVis(){var t,e,a;xDetailScale=d3.time.scale().domain(d3.extent(dateList,function(t){return t})).range([0,bbDetail.w]);var r=svg.append("g").attr({"class":"detailFrame",transform:"translate("+bbDetail.x+","+bbDetail.y+")"});a=d3.scale.linear().domain([0,d3.max(allDates,function(t){return d3.max(t.values,function(t){return t.count})})]).range([bbDetail.h,0]),t=d3.svg.axis().scale(xDetailScale).orient("bottom").ticks(4).tickFormat(d3.time.format("%b")),e=d3.svg.axis().scale(a).orient("left").ticks(6);var n=d3.svg.area().x(function(t){return xDetailScale(t.date)}).y0(bbDetail.h).y1(function(t){return a(t.count)}),i=d3.svg.line().x(function(t){return xDetailScale(t.date)}).y(function(t){return a(t.count)}).interpolate("linear");r.append("g").attr({"class":"x axis",transform:"translate(0,"+bbDetail.h+")"}).call(t),r.append("g").attr({"class":"y axis"}).call(e).append("text").attr("x",-5).attr("y",-45).attr("dy","30px").style("text-anchor","end").text("Coverage");var s=svg.selectAll(".dataTypes").data(allDates).enter().append("g").attr("class","dataTypes");s.append("path").attr({"class":"traditionalMediaPath",d:function(t){return i(t.values)},transform:"translate(0,"+bbDetail.y+")"}).style({stroke:function(t){return color(t.name)},fill:"none"}),s.selectAll("circle").data(function(t){return t.values}).enter().append("circle").attr({"class":"dot",cx:function(t){return xDetailScale(t.date)},cy:function(t){return a(t.count)},r:4,transform:"translate(0,"+bbDetail.y+")"}).style({fill:function(t){var e=color(t.name),a=d3.rgb(e).darker();return a}}).on("mouseover",function(t){d3.select(this).transition().duration(25).attr("r",10),o.show(t)}).on("mouseleave",function(t){d3.select(this).transition().duration(25).attr("r",4),o.hide(t)}),d3.select("#crisisTitle").html("<h3>Typhoon Haiyan</h3>"),d3.select("#crisisStory").html('Typhoon Haiyan, known as Typhoon Yolanda in the Philippines, was a powerful tropical cyclone that devastated portions of Southeast Asia, particularly the Philippines, on November 8, 2013. <a href="http://en.wikipedia.org/wiki/Typhoon_Haiyan" class="storySource">&mdash; Wikipedia</a>'),r.selectAll(".line").data(storyPoints).enter().append("line").attr({"class":"storyline",x1:function(t){return xDetailScale(t.date)},x2:function(t){return xDetailScale(t.date)},y1:-bbDetail.y,y2:bbDetail.h}),r.selectAll(".storyTriangle").data(storyPoints).enter().append("path").attr({"class":"storyTriangle",transform:function(t){return"translate("+xDetailScale(t.date)+","+-bbDetail.y+")"},d:d3.svg.symbol().type("triangle-down").size(256)}).on("mouseover",function(t){var e=parseDateTips(t.date);d3.select(".crisisDate").remove(),d3.select("#crisisTitle").append("span").html(e).attr("class","crisisDate"),d3.select("#crisisStory").html(t.title),d3.selectAll(".storyTriangle").transition().style("fill","#919191").attr("d",d3.svg.symbol().type("triangle-down").size(256)),d3.select(this).transition().style("fill","#3D8699").attr("d",d3.svg.symbol().type("triangle-down").size(512))});var o=d3.tip().html(function(t){return console.log("d3tip",t),t.count+" articles on <span class='sourceName'>"+t.name+"</span> during<br>the 30 days prior to "+parseDateTips(t.date)}).direction("e").attr("class","d3-tip e");r.call(o);var l=svg.selectAll(".legend").data(sources).enter().append("g").attr("class","legend").attr("transform",function(t,e){return"translate(0,"+28*e+")"}).on("mouseout",function(t){d3.selectAll("rect").attr("opacity","1")});l.append("rect").attr("x",width-18).attr("width",18).attr("height",18).style("fill",color),l.append("text").attr("x",width-24).attr("y",9).attr("dy",".35em").style("text-anchor","end").text(function(t){return t})}function sourceChanged(){var t=d3.event.target.value;"bbc"==t?doBBC():"google"==t&&doGoogle()}var allDates,bbDetail,bbOverview,detailFrame,dateList,blogDates,color,storyPoints,duplicateAllDates,duplicateTraditonalDates,duplicateBlogDates,padding,parseYear,sources,svg,xDetailScale,xOverviewScale,margin={top:50,right:50,bottom:0,left:100},width=960-margin.left-margin.right,height=400-margin.bottom-margin.top;bbOverview={x:0,y:10,w:width,h:50},bbDetail={x:0,y:25,w:width,h:300};var padding=30,parseDate=d3.time.format("%Y-%m-%dT%H:%M:%S+00:00").parse,parseDateQuery=d3.time.format("%Y-%m-%d").parse,parseDateSimple=d3.time.format("%b %d %Y"),parseDateTips=d3.time.format("%b %d, %Y"),parseStorypoint=d3.time.format("%Y-%m-%d").parse;allDates=[],dateList=[],duplicateTraditonalDates=[],duplicateBlogDates=[],blogDates=[],svg=d3.select("#timelineVis").append("svg").attr({"class":"timeline",width:width+margin.left+margin.right,height:height+margin.top+margin.bottom}).append("g").attr({transform:"translate("+margin.left+","+margin.top+")"}),svg.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",width).attr("height",height);var mediaStats="productiondata/haiyan-meta/google-media_stats-no-m.csv",blogSource="data/haiyan/2014-04-10 12.53.14_haiyan-google-blog_query_stats.csv";getData(),d3.select("#dataSourceSelect").on("change",sourceChanged);