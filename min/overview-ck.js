function addClassNameListener(t,e){var a=document.getElementById(t),r=a.className;window.setInterval(function(){var t=a.className;t!==r&&(e(),r=t)},10)}function numberWithCommas(t){if(isNaN(t))return t;var e=t.toString().split(".");return e[0]=e[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),e.join(".")}function loadedDataCallBack(t,e,a){console.log("--- START ::: loadedDataCallback ---"),world_data=topojson.feature(e,e.objects.countries).features,a.forEach(function(t){var e=t.query_distinct.slice(t.query_distinct.indexOf("(")+1,t.query_distinct.lastIndexOf(")")),a=t.query_distinct.slice(0,t.query_distinct.indexOf("(")-1),r="CS"===a?1:+t.raw_result_count;mediaData[e]={name:e,code:a,articles:r},mediaBarData.push({name:e.replaceAll("&quot;",""),code:a,articles:r})}),console.log("mediaData: ",mediaData);var r=_.pluck(mediaData,"articles");min=d3.min(r),mean=d3.sum(r)/r.length,max=d3.max(r),color=d3.scale.quantile().domain([min,mean,max]).range(colorScale),country=countries.selectAll(".country").data(world_data),country.enter().append("path").attr("class","country").attr("d",path).on("mouseover",tip.show).on("mousemove",function(){return tip.style("top",d3.event.pageY+16+"px").style("left",d3.event.pageX+16+"px")}).on("mouseout",tip.hide),country.call(tip),renderBarChart(),renderGlobe(),d3.selectAll("input").on("click",function(){reorder(this.value)}),addClassNameListener("tab_1_globe",function(){var t=document.getElementById("tab_1_globe").className}),addClassNameListener("tab_2_bar",function(){var t=document.getElementById("tab_2_bar").className}),console.log("--- END ::: loadedDataCallback ---")}function renderGlobe(){country.attr("fill",function(t){return _.has(mediaData,t.properties.name)?color(mediaData[t.properties.name].articles):"white"}),colorlegend("#legend_globe",color,"quantile",{title:"results by country",boxHeight:15,boxWidth:30,fill:!1,linearBoxes:11}),startAnimation()}function stopAnimation(){done=!0}function startAnimation(){done=!1,then=Date.now(),d3.timer(function(){var t=velocity*(Date.now()-then);return projection.rotate([t,0,0]),svg.selectAll("path").attr("d",path.projection(projection)),done})}function mousedown(){done?Date.now()-lastClick<500&&startAnimation():stopAnimation(),lastClick=Date.now(),m0=[d3.event.pageX,d3.event.pageY],o0=projection.rotate(),d3.event.preventDefault()}function mousemove(){if(m0){var t=[d3.event.pageX,d3.event.pageY],e=[o0[0]+(t[0]-m0[0])/8,0];projection.rotate(e),svg.selectAll("path").attr("d",path)}}function mouseup(){m0&&(mousemove(),m0=null)}function renderBarChart(){stopAnimation();var t=_.pluck(mediaBarData,"name");xScale.domain([min,max]),yScale.domain(t),groups&&groups.remove(),groups=gBar.append("g").selectAll("g").data(mediaBarData).enter().append("g").attr("id",function(t){return"bar_group_"+t.code}).attr("transform",function(t){return"translate("+countryWidth+", "+yScale(t.name)+")"}),bars=groups.append("rect").attr("class","bar_rect").attr("id",function(t){return"bar_rect_"+t.code}).attr("width",function(t){return xScale(t.articles)}).attr("height",bar_height-bar_padding).style("fill",function(t){return color(t.articles)}).on("mouseover",function(t){fill(t,!0)}).on("mouseout",function(t){fill(t,!1)}),groups.append("text").attr("class","bar_text").attr("id",function(t){return"bar_text_country_"+t.code}).attr("x","-"+x_pad).attr("dy",y_em).style("fill",defaultBarTextColor).text(function(t){return t.name}),groups.append("g").append("text").attr("class","bar_text").attr("id",function(t){return"bar_text_result_"+t.code}).attr("x",function(t){var e=xScale(t.articles)-x_pad;return 0>e?5:e}).attr("dy",y_em).style("fill",function(t){var e=color(t.articles);return e===myColors.Greens[3]?lightBarTextColor:defaultBarTextColor}).text(function(t){var e=xScale(t.articles)-x_pad;return 0>e?"0":t.articles}),reorder("result")}function fill(t,e){var a=d3.select("#bar_group_"+t.code);null!=a&&(e?(a.select("rect").style("fill",hoverColor),a.select("text").style("fill",hoverColor)):(a.select("rect").style("fill",color(t.articles)),a.select("text").style("fill",defaultBarTextColor)))}function reorder(t){groups.sort(function(e,a){return"country"===t?isCountrySortDescending?d3.ascending(e.name,a.name):d3.descending(e.name,a.name):internalNumberSort(e,parseInt(e.articles),a,parseInt(a.articles),isResultSortDescending)}),"country"===t?(console.log("... reorder for 'country', descending? "+isCountrySortDescending),isCountrySortDescending=isCountrySortDescending?!1:!0,isResultSortDescending=!1):(console.log("... reordered for 'result', descending? "+isResultSortDescending),isResultSortDescending=isResultSortDescending?!1:!0,isCountrySortDescending=!0),groups.transition().duration(750).delay(function(t,e){return 10*e}).attr("transform",function(t,e){return"translate("+countryWidth+", "+e*bar_height+")"})}function internalNumberSort(t,e,a,r,n){return n?isNaN(e)||isNaN(r)||e!=r?d3.ascending(e,r):d3.ascending(t.name,a.name):isNaN(e)||isNaN(r)||e!=r?d3.descending(e,r):d3.ascending(t.name,a.name)}var color,min,mean,max,mediaData={},mediaBarData=[],isCountrySortDescending=!0,isResultSortDescending=!1,maxWidth=960,maxHeight=650,width=maxWidth,height=maxHeight-150,margin={top:0,right:0,bottom:0,left:0},myColors={Grays:["#f0f0f0","#d9d9d9"],Blues:["#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6"],Greens:["#74c476","#41ab5d","#238b45","#006d2c"]},colorScale=myColors.Grays.concat(myColors.Blues).concat(myColors.Greens);String.prototype.replaceAll=function(t,e){var a=this;return a.replace(new RegExp(t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),e)};var country,world_data,svg=d3.select("#overviewVis").append("svg").attr({width:width+margin.left+margin.right,height:height+margin.top+margin.bottom,transform:"translate("+margin.left+","+margin.top+")"}).on("mousedown",mousedown).on("mousemove",mousemove).on("mouseup",mouseup),countries=svg.append("g").attr({id:"countries",width:width,height:height}),tip=d3.tip().attr("class","d3-tip none").offset([-10,0]).html(function(t){var e,a="white";return t&&mediaData[t.properties.name]&&!isNaN(mediaData[t.properties.name].articles)?(a=color(mediaData[t.properties.name].articles),e=numberWithCommas(mediaData[t.properties.name].articles)):e="(no data)","<strong>Country: </strong><span style='color:"+a+";'><em>"+t.properties.name+"</em></span><span style='color:white;'>, </span><strong>Indicator Value: </strong><span style='color:"+a+";'><em>"+e+"</em></span>"}),projection=d3.geo.orthographic().scale(250).translate([width/2,height/2]).clipAngle(90),path=d3.geo.path().projection(projection),graticule=d3.geo.graticule();svg.append("g").append("path").datum(graticule).attr("class","graticule").attr("d",path);var m0,o0,done,velocity=.02,then=Date.now(),lastClick=0;queue().defer(d3.json,"productiondata/globe.json").defer(d3.csv,"/productiondata/haiyan/google-country_stats.csv").await(loadedDataCallBack);var defaultBarTextColor="#636363",lightBarTextColor="#bdbdbd",hoverColor="orangered",marginBar={top:50,bottom:0,left:0,right:50},widthBar=maxWidth-marginBar.left-marginBar.right,heightBar=maxHeight-marginBar.top-marginBar.bottom,countryWidth=250,xScale=d3.scale.pow().exponent(.1).range([0,widthBar-countryWidth]),yScale=d3.scale.ordinal().rangeRoundBands([0,heightBar],.8,0),bar_height=15,bar_padding=1,x_pad=5,y_em=".95em",groups=null,bars=null,svgBar=d3.select("#country_bar_chart").append("svg").attr("width",widthBar+marginBar.left+marginBar.right).attr("height",3e3),gBar=svgBar.append("g").attr("transform","translate("+marginBar.left+","+marginBar.top+")");